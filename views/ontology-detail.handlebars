<!-- views/ontology-detail.handlebars - Enhanced template for GraphDB ontologies -->
<div class="page-container">
  <!-- Table of Contents Sidebar -->
  <div class="toc-sidebar">
    <div class="toc-content">
      <h3>Innehållsförteckning</h3>
      <ul class="toc-list">
        <li><a href="#metadata" class="toc-active">Metadata</a></li>
        <li><a href="#overview">Översikt</a></li>
        
        {{#if ontology.classes.length}}
        <li>
          <a href="#classes">Klasser ({{ontology.classes.length}})</a>
          <ul class="toc-sublist">
            {{#each ontology.classes}}
              <li><a href="#class-{{@index}}">{{this.label}}</a></li>
            {{/each}}
          </ul>
        </li>
        {{/if}}
        
        {{#if ontology.properties.objectProperties.length}}
        <li>
          <a href="#object-properties">Objektegenskaper ({{ontology.properties.objectProperties.length}})</a>
          <ul class="toc-sublist">
            {{#each ontology.properties.objectProperties}}
              <li><a href="#prop-obj-{{@index}}">{{this.label}}</a></li>
            {{/each}}
          </ul>
        </li>
        {{/if}}
        
        {{#if ontology.properties.datatypeProperties.length}}
        <li>
          <a href="#datatype-properties">Datatypegenskaper ({{ontology.properties.datatypeProperties.length}})</a>
          <ul class="toc-sublist">
            {{#each ontology.properties.datatypeProperties}}
              <li><a href="#prop-dt-{{@index}}">{{this.label}}</a></li>
            {{/each}}
          </ul>
        </li>
        {{/if}}
        
        {{#if ontology.properties.annotationProperties.length}}
        <li>
          <a href="#annotation-properties">Anteckningsegenskaper ({{ontology.properties.annotationProperties.length}})</a>
          <ul class="toc-sublist">
            {{#each ontology.properties.annotationProperties}}
              <li><a href="#prop-ann-{{@index}}">{{this.label}}</a></li>
            {{/each}}
          </ul>
        </li>
        {{/if}}
        
        <li><a href="#namespaces">Namnrymder</a></li>
        <li><a href="#legend">Teckenförklaring</a></li>
        <li><a href="#downloads">Nedladdningar</a></li>
      </ul>
    </div>
  </div>

  <!-- Main Content -->
  <div class="ontology-container">
    <h1>{{ontology.title}}</h1>

    <h2 id="metadata">Metadata</h2>
    <div class="metadata-section">
      <p><strong>IRI</strong><br>
      <code>{{ontology.uri}}</code></p>

      <p><strong>Titel</strong><br>
      {{ontology.title}}</p>

      {{#if ontology.creator}}
      <p><strong>Skapare</strong><br>
      {{ontology.creator}}</p>
      {{/if}}

      {{#if ontology.publisher}}
      <p><strong>Utgivare</strong><br>
      {{ontology.publisher}}
      </p>
      {{/if}}

      {{#if ontology.created}}
      <p><strong>Skapad datum</strong><br>
      {{ontology.created}}</p>
      {{/if}}

      {{#if ontology.modified}}
      <p><strong>Modifierad datum</strong><br>
      {{ontology.modified}}</p>
      {{/if}}

      {{#if ontology.license}}
      <p><strong>Licens</strong><br>
      <a href="{{ontology.license}}">{{ontology.license}}</a></p>
      {{/if}}

      {{#if ontology.version}}
      <p><strong>Version</strong><br>
      {{ontology.version}}</p>
      {{/if}}

      {{#if ontology.preferredNamespacePrefix}}
      <p><strong>Föredragen namnrymdsprefix</strong><br>
      {{ontology.preferredNamespacePrefix}}</p>
      {{/if}}

      {{#if ontology.preferredNamespaceUri}}
      <p><strong>Föredragen namnrymds-URI</strong><br>
      <code>{{ontology.preferredNamespaceUri}}</code></p>
      {{/if}}

      <p><strong>Beskrivning</strong><br>
      {{ontology.description}}</p>
    </div>

    <h2 id="overview">Översikt</h2>
    <div class="overview-section">
      <div class="stats-summary">
        <div class="stat-item">
          <span class="stat-value">{{ontology.stats.classes}}</span> Klasser
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ontology.stats.properties}}</span> Egenskaper
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ontology.stats.individuals}}</span> Individer
        </div>
      </div>
      
      <p>{{ontology.description}}</p>
      
      {{#if ontology.relatedOntologies.length}}
      <div class="related-ontologies-section">
        <h3>Relaterade ontologier</h3>
        <div class="related-ontologies-list">
          {{#each ontology.relatedOntologies}}
            <div class="related-ontology-item">
              <h4><a href="/ontology/detail?uri={{encodeURIComponent this.uri}}&showLabels={{../showLabels}}">{{this.title}}</a></h4>
              <p class="related-ontology-desc">{{truncate this.description 150}}</p>
            </div>
          {{/each}}
        </div>
      </div>
      {{/if}}
    </div>

    {{#if ontology.classes.length}}
    <h2 id="classes">Klasser</h2>
    <div class="classes-section">
      <div class="filter-control">
        <input type="text" id="classFilter" placeholder="Filtrera klasser..." class="filter-input">
      </div>
      
      <div class="entity-items">
        {{#each ontology.classes}}
        <div id="class-{{@index}}" class="entity-item class-item">
          <h3>{{this.label}} <sup>c</sup></h3>
          <p><strong>IRI</strong><br><code>{{this.uri}}</code></p>
          
          {{#if this.description}}
          <p><strong>Beskrivning</strong><br>
          {{this.description}}</p>
          {{/if}}
          
          {{#if this.domain}}
          <p><strong>I domän av</strong><br>
          {{this.domain}}</p>
          {{/if}}
          
          {{#if this.range}}
          <p><strong>I område av</strong><br>
          {{this.range}}</p>
          {{/if}}
        </div>
        {{/each}}
      </div>
    </div>
    {{/if}}

    {{#if ontology.properties.objectProperties.length}}
    <h2 id="object-properties">Objektegenskaper</h2>
    <div class="properties-section">
      <div class="filter-control">
        <input type="text" id="propObjFilter" placeholder="Filtrera objektegenskaper..." class="filter-input">
      </div>
      
      <div class="entity-items">
        {{#each ontology.properties.objectProperties}}
        <div id="prop-obj-{{@index}}" class="entity-item property-item">
          <h3>{{this.label}} <sup>op</sup></h3>
          <p><strong>IRI</strong><br><code>{{this.uri}}</code></p>
          
          {{#if this.description}}
          <p><strong>Beskrivning</strong><br>
          {{this.description}}</p>
          {{/if}}
          
          {{#if this.domain}}
          <p><strong>Domän</strong><br>
          {{#if ../showLabels}}
            {{#if (lookup ../labelMap this.domain)}}
              <a href="#classes">{{lookup ../labelMap this.domain}}</a> <sup>c</sup>
            {{else}}
              <a href="#classes">{{this.domain}}</a> <sup>c</sup>
            {{/if}}
          {{else}}
            <a href="#classes">{{this.domain}}</a> <sup>c</sup>
          {{/if}}
          </p>
          {{/if}}
          
          {{#if this.range}}
          <p><strong>Område</strong><br>
          {{#if ../showLabels}}
            {{#if (lookup ../labelMap this.range)}}
              <a href="#classes">{{lookup ../labelMap this.range}}</a> <sup>c</sup>
            {{else}}
              <a href="#classes">{{this.range}}</a> <sup>c</sup>
            {{/if}}
          {{else}}
            <a href="#classes">{{this.range}}</a> <sup>c</sup>
          {{/if}}
          </p>
          {{/if}}
        </div>
        {{/each}}
      </div>
    </div>
    {{/if}}

    {{#if ontology.properties.datatypeProperties.length}}
    <h2 id="datatype-properties">Datatypegenskaper</h2>
    <div class="properties-section">
      <div class="filter-control">
        <input type="text" id="propDtFilter" placeholder="Filtrera datatypegenskaper..." class="filter-input">
      </div>
      
      <div class="entity-items">
        {{#each ontology.properties.datatypeProperties}}
        <div id="prop-dt-{{@index}}" class="entity-item property-item">
          <h3>{{this.label}} <sup>dp</sup></h3>
          <p><strong>IRI</strong><br><code>{{this.uri}}</code></p>
          
          {{#if this.description}}
          <p><strong>Beskrivning</strong><br>
          {{this.description}}</p>
          {{/if}}
          
          {{#if this.domain}}
          <p><strong>Domän</strong><br>
          {{#if ../showLabels}}
            {{#if (lookup ../labelMap this.domain)}}
              <a href="#classes">{{lookup ../labelMap this.domain}}</a> <sup>c</sup>
            {{else}}
              <a href="#classes">{{this.domain}}</a> <sup>c</sup>
            {{/if}}
          {{else}}
            <a href="#classes">{{this.domain}}</a> <sup>c</sup>
          {{/if}}
          </p>
          {{/if}}
          
          {{#if this.range}}
          <p><strong>Område</strong><br>
          <code>{{this.range}}</code>
          </p>
          {{/if}}
        </div>
        {{/each}}
      </div>
    </div>
    {{/if}}

    {{#if ontology.properties.annotationProperties.length}}
    <h2 id="annotation-properties">Anteckningsegenskaper</h2>
    <div class="annotation-props-section">
      <div class="entity-items">
        {{#each ontology.properties.annotationProperties}}
        <div id="prop-ann-{{@index}}" class="entity-item">
          <h3>
            <a href="#prop-ann-{{@index}}" class="property-title-link">
              {{this.label}} <sup>ap</sup>
            </a>
          </h3>
          <p><strong>IRI</strong>
            <a href="#prop-ann-{{@index}}" class="iri-link">
              <code>{{this.uri}}</code>
            </a>
          </p>
          <div class="property-description">
            {{#if this.description}}
              <p>{{this.description}}</p>
            {{else}}
              <p>En anteckningsegenskap som används för ontologi-dokumentation.</p>
            {{/if}}
          </div>
        </div>
        {{/each}}
      </div>
    </div>
    {{/if}}

    <h2 id="namespaces">Namnrymder</h2>
    <div class="namespaces-section">
      <table class="namespaces-table">
        {{#each ontology.namespaces}}
        <tr>
          <td><strong>{{this.prefix}}</strong></td>
          <td><code>{{this.uri}}</code></td>
        </tr>
        {{/each}}
        
        <!-- Add common namespaces if none were found -->
        {{#unless ontology.namespaces.length}}
          <tr>
            <td><strong>rdf</strong></td>
            <td><code>http://www.w3.org/1999/02/22-rdf-syntax-ns#</code></td>
          </tr>
          <tr>
            <td><strong>rdfs</strong></td>
            <td><code>http://www.w3.org/2000/01/rdf-schema#</code></td>
          </tr>
          <tr>
            <td><strong>owl</strong></td>
            <td><code>http://www.w3.org/2002/07/owl#</code></td>
          </tr>
          <tr>
            <td><strong>xsd</strong></td>
            <td><code>http://www.w3.org/2001/XMLSchema#</code></td>
          </tr>
        {{/unless}}
      </table>
    </div>

    <h2 id="legend">Teckenförklaring</h2>
    <div class="legend-section">
      <p><sup>c</sup> Klasser <sup>op</sup> Objektegenskaper <sup>dp</sup> Datatypegenskaper <sup>ap</sup> Anteckningsegenskaper</p>
    </div>
    
    <div id="downloads" class="download-section">
      <h2>Nedladdningar</h2>
      <div class="download-links">
        {{#each downloadLinks}}
        <a href="{{this.url}}" class="download-link" download="ontology.{{this.extension}}">
          Ladda ner som {{this.format}}
        </a>
        {{/each}}
      </div>
    </div>
  
    <div class="display-control">
      <label for="displayToggle">Visa mänskligt läsbara etiketter:</label>
      <label class="toggle-switch">
        <input type="checkbox" id="displayToggle" {{#if showLabels}}checked{{/if}}>
        <span class="toggle-slider"></span>
      </label>
      <span class="toggle-label">{{#if showLabels}}På{{else}}Av{{/if}}</span>
    </div>
  
    <div class="navigation-links">
      <a href="/" class="nav-link">Tillbaka till startsidan</a>
      <a href="/ontology/products?uri={{encodeURIComponent ontology.uri}}" class="nav-link">Visa relaterade produkter</a>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize filtering
    initFilter('#classFilter', '.class-item');
    initFilter('#propObjFilter', '.property-item');
    initFilter('#propDtFilter', '.property-item');
    
    // Update display toggle
    const displayToggle = document.getElementById('displayToggle');
    const toggleLabel = document.querySelector('.toggle-label');
    
    if (displayToggle && toggleLabel) {
      displayToggle.addEventListener('change', function() {
        // Update the label text
        toggleLabel.textContent = this.checked ? 'På' : 'Av';
        
        // Create URL with updated showLabels parameter
        const url = new URL(window.location.href);
        url.searchParams.set('showLabels', this.checked ? 'true' : 'false');
        
        // Redirect to the new URL
        window.location.href = url.toString();
      });
    }
    
    // Initialize TOC highlight on scroll
    initTOCHighlight();
    
    // Make the TOC stay in view when scrolling
    window.addEventListener('scroll', function() {
      const toc = document.querySelector('.toc-sidebar');
      if (toc) {
        if (window.innerWidth > 992) { // Only apply this on larger screens
          const scrollPosition = window.scrollY;
          toc.style.top = (scrollPosition > 0) ? '0' : '';
        }
      }
    });
    
    // Smooth scrolling for anchor links
    document.querySelectorAll('.toc-list a, .toc-sublist a').forEach(anchor => {
      anchor.addEventListener('click', function(e) {
        e.preventDefault();
        
        const targetId = this.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);
        
        if (targetElement) {
          window.scrollTo({
            top: targetElement.offsetTop - 20,
            behavior: 'smooth'
          });
          
          // Update URL without reload
          history.pushState(null, null, `#${targetId}`);
          
          // Highlight the clicked TOC item
          highlightTOCItem(this);
        }
      });
    });
    
    // Check for hash in URL on page load to scroll to section
    if (window.location.hash) {
      const targetId = window.location.hash.substring(1);
      const targetElement = document.getElementById(targetId);
      
      if (targetElement) {
        setTimeout(() => {
          window.scrollTo({
            top: targetElement.offsetTop - 20,
            behavior: 'auto'
          });
          
          // Find and highlight the corresponding TOC item
          const tocItem = document.querySelector(`.toc-list a[href="#${targetId}"], .toc-sublist a[href="#${targetId}"]`);
          if (tocItem) {
            highlightTOCItem(tocItem);
          }
        }, 100);
      }
    }
  });
  
  // Function to initialize filtering
  function initFilter(inputSelector, itemSelector) {
    const input = document.querySelector(inputSelector);
    if (!input) return;
    
    input.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const items = document.querySelectorAll(itemSelector);
      
      items.forEach(item => {
        // Check if item contains the search term
        const text = item.textContent.toLowerCase();
        
        if (searchTerm === '' || text.includes(searchTerm)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    });
  }
  
  // Function to highlight active TOC item
  function highlightTOCItem(item) {
    // Remove active class from all TOC items
    document.querySelectorAll('.toc-list a, .toc-sublist a').forEach(link => {
      link.classList.remove('toc-active');
    });
    
    // Add active class to the clicked item
    item.classList.add('toc-active');
  }
  
  // Function to highlight TOC items based on scroll position
  function initTOCHighlight() {
    // Get all section elements
    const sections = document.querySelectorAll('h2[id], .entity-item[id]');
    
    // Observe sections visibility
    window.addEventListener('scroll', function() {
      let currentSection = '';
      const scrollPosition = window.scrollY;
      
      // Find the current section
      sections.forEach(section => {
        const sectionTop = section.offsetTop - 100;
        const sectionHeight = section.offsetHeight;
        
        if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
          currentSection = section.getAttribute('id');
        }
      });
      
      // Highlight the corresponding TOC item
      if (currentSection) {
        const tocItem = document.querySelector(`.toc-list a[href="#${currentSection}"], .toc-sublist a[href="#${currentSection}"]`);
        
        if (tocItem) {
          document.querySelectorAll('.toc-list a, .toc-sublist a').forEach(link => {
            link.classList.remove('toc-active');
          });
          
          tocItem.classList.add('toc-active');
          
          // If it's a subitem, also highlight its parent
          const parent = tocItem.closest('.toc-sublist');
          if (parent && parent.previousElementSibling) {
            parent.previousElementSibling.classList.add('toc-active');
          }
        }
      }
    });
  }
</script>